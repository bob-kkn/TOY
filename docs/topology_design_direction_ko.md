# 도로 면형 기반 중심선 추출 파이프라인: 설계 방향 제안

이 문서는 현재 파이프라인(`면형 통합 -> 뼈대 추출 -> 위상 정제`)에서 발생하는 임계값 의존, 밀집 구간 간섭, 중복 중앙선 분리 실패, 곡선-노이즈 트레이드오프 문제를 완화하기 위한 **실무 중심의 설계 방향**을 정리한다.

## 1) 임계값 하드코딩은 "나쁜 것"이 아니라 "단계"다

현재처럼 모듈별 최적 수치를 하드코딩해 품질을 확보하는 전략은 초기/탐색 단계에서 합리적이다. 다만 유지보수를 위해 아래처럼 발전 경로를 고정해두는 것을 권장한다.

- **Phase A (현재)**: 코드 내부 상수로 빠른 탐색
- **Phase B**: 상수는 유지하되 `프로파일(urban/dense/rural)` 키를 두고 묶음 관리
- **Phase C**: 입력 데이터의 측정치(폭 분포, 꼭짓점 밀도, 교차로 밀도)로 프로파일 자동 선택
- **Phase D**: 프로젝트별 보정값만 외부 설정으로 오버라이드

핵심은 "완전 자동"보다 "반자동(프로파일 선택 + 소량 보정)"이 현장 안정성이 높다는 점이다.

---

## 2) 파이프라인 구조를 "단일 골격"에서 "복수 가설 + 선택"으로 전환

현재 보로노이 단일 결과에 후처리를 강하게 거는 구조에서는, 어려운 구간(밀집/병렬/합류)에서 한 번 깨진 위상을 복구하기 어렵다.

권장 구조:

1. **후보 생성(다중)**
   - Voronoi 기반 skeleton
   - Polygon straight-skeleton(가능 시)
   - 반대 경계쌍(pairing) 기반 centerline
2. **후보 스코어링**
   - 경계로부터 대칭성
   - 곡률 안정성(지그재그 패널티)
   - 연결성 보존(끊김/불필요 분기 패널티)
3. **구간별 선택/혼합**
   - 전체를 하나의 방법으로 처리하지 말고, 타일/클러스터 단위로 최적 후보 선택

즉, "한 알고리즘의 파라미터 튜닝"보다 "구간별 알고리즘 선택"이 변수 무한 상황에서 더 견고하다.

---

## 3) 밀집 면형 간섭: 먼저 "도로 객체 분해"를 수행

면형이 붙어 있을 때 중심선이 합쳐지는 이유는, skeleton 단계 이전에 도로 객체 경계가 불충분하게 분리되기 때문이다.

권장 전처리:

- **협곡(neck) 검출 후 절개(cut)**
  - 폭이 급격히 줄어드는 구간을 찾아 폴리곤을 먼저 분할
- **로컬 Delaunay / medial radius 기반 분할**
  - 내접반경 급감 구간을 분할 후보로 사용
- **접합부/차로부 분리 라벨링**
  - 교차로 광장부는 별도 클래스로 분리해 일반 도로부와 다른 기준 적용

요점: "통합 -> 추출" 이전에 "분해 -> 유형화"가 먼저다.

---

## 4) 중복 중앙선(평행 도로) 문제: 그래프 위상 규칙을 명시적으로 추가

인접 두 면형에서 선이 하나로 붙는 현상은 geometry 기반 추출만으로는 자주 발생한다. 아래 규칙을 **위상 레벨의 제약조건**으로 추가해야 한다.

- **최소 병렬 간격 제약**: 일정 구간 이상 함께 진행하는 선들은 단일선 병합 금지
- **차수/각도 기반 분기 보존**: 병합 시 노드 차수 변화가 임계 이상이면 병합 거부
- **원본 면형 소속 추적(provenance)**: skeleton edge가 어떤 polygon 집합에서 왔는지 태그 유지 후, 상이한 provenance 간 무분별 병합 차단

이 규칙은 수치 튜닝보다 재현성이 높고, 데이터셋이 바뀌어도 의도 보존에 유리하다.

---

## 5) "수학적 정직성 vs 실무 직관" 문제: 단순화 1단계 대신 2단계 필터

한 번의 tolerance로 노이즈 제거와 커브 보존을 동시에 만족시키기 어렵다. 다음 2단계를 권장한다.

1. **고주파 노이즈 제거**
   - 짧은 파장 지그재그만 타겟팅 (예: 방향 변화의 고주파 성분)
2. **형상 보존 단순화**
   - 곡률 반경이 큰 실제 커브는 보존, 미세 굴곡만 완화

추가로 교차로 접근부(approach zone)는 별도 tolerance를 적용해, 본선보다 더 강한 직선화를 허용한다.

---

## 6) 권장 운영 전략: "정답 파라미터" 대신 "실패 유형 카탈로그"

변수가 무한한 상황에서 가장 효과적인 운영 단위는 단일 숫자가 아니라 실패 유형이다.

- 실패 유형 예시
  - A: 중앙선 합체
  - B: 병렬선 소실
  - C: 교차부 스파이크
  - D: 커브 직선화 과다
- 각 유형마다
  - 탐지 지표(자동 QA)
  - 우선 적용 규칙
  - 마지막 수단 임계값

이렇게 하면 신규 데이터셋이 들어와도 "유형별 대응"으로 확장 가능하다.

---

## 7) 지금 코드베이스에 바로 반영 가능한 최소 변경 순서

1. 각 정제 모듈 출력 edge에 `provenance_id`(기여 polygon id 집합 해시) 부여
2. 병합 단계에 `provenance 불일치 병합 금지` 옵션 추가
3. 교차로 접근부/본선 구분 라벨링 후 tolerance 이원화
4. QA 리포트에 실패 유형 카운트(A~D) 추가

위 4가지는 대규모 알고리즘 교체 없이도 품질 하락 원인을 분해해준다.

---

## 8) 결론

현재 접근은 충분히 타당하며, "하드코딩을 했기 때문에 실패"가 아니라 "단일 방법으로 모든 위상을 설명하려는 구조"가 병목일 가능성이 높다.

다음 단계는 임계값을 당장 외부화하는 것이 아니라,

- (a) 도로 객체를 먼저 분해하고,
- (b) 후보를 복수로 만들고,
- (c) 위상 제약(특히 provenance)을 명시하며,
- (d) 실패 유형 기반 QA로 운영

하는 방향이 더 실무적으로 안전하다.
